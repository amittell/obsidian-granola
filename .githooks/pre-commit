#!/bin/bash

# Pre-commit hook for obsidian-granola plugin
# Catches issues locally before they reach GitHub Actions

set -e

echo "ğŸ” Running pre-commit checks..."

# Check if npm is available
if ! command -v npm &> /dev/null; then
    echo "âŒ npm not found. Please install Node.js"
    exit 1
fi

# Check if node_modules exists
if [ ! -d "node_modules" ]; then
    echo "ğŸ“¦ Installing dependencies..."
    npm install
fi

# 1. Format check (fast, catches 90% of style issues)
echo "âœ¨ Checking code formatting..."
if ! npm run format:check; then
    echo "âŒ Code formatting issues detected!"
    echo "ğŸ’¡ Run 'npm run format' to fix automatically"
    exit 1
fi

# 2. TypeScript compilation check (catches syntax errors)
echo "ğŸ”§ Checking TypeScript compilation..."
if ! npm run type-check; then
    echo "âŒ TypeScript compilation failed!"
    echo "ğŸ’¡ Fix the TypeScript errors before committing"
    exit 1
fi

# 3. Build check (ensures the plugin compiles)
echo "ğŸ“¦ Testing build..."
if ! npm run build:check; then
    echo "âŒ Build failed!"
    echo "ğŸ’¡ Fix build errors before committing"
    exit 1
fi

# 4. Quick lint check (catches obvious code issues)
echo "ğŸ§¹ Running quick lint check..."
if ! npm run lint:quick; then
    echo "âŒ Linting issues detected!"
    echo "ğŸ’¡ Run 'npm run lint:fix' to auto-fix or fix manually"
    exit 1
fi

# 5. Initialization order tests (catches logger and component issues)
echo "ğŸ”§ Running initialization order tests..."
if ! npm test -- --testPathPattern="initialization-order.test.ts" --silent; then
    echo "âŒ Initialization order tests failed!"
    echo "ğŸ’¡ Check component initialization order and dependencies"
    exit 1
fi

# 6. Bundle tests (catches issues in built code)
echo "ğŸ“¦ Running bundle integration tests..."
if ! npm test -- --testPathPattern="bundle.test.ts" --silent; then
    echo "âŒ Bundle tests failed!"
    echo "ğŸ’¡ Issues detected in built plugin code"
    exit 1
fi

echo "âœ… All pre-commit checks passed!"
echo "ğŸš€ Ready to commit"